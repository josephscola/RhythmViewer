
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Introduction for Mypyc Contributors &#8212; My sample book</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../../_static/jquery.js"></script>
    <script src="../../../../../../_static/underscore.js"></script>
    <script src="../../../../../../_static/doctools.js"></script>
    <script src="../../../../../../_static/clipboard.min.js"></script>
    <script src="../../../../../../_static/copybutton.js"></script>
    <script src="../../../../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">My sample book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../../../../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../../markdown.html">
   Markdown Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../../notebooks.html">
   Content with notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../../markdown-notebooks.html">
   Notebooks with MyST Markdown
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fenv/lib/python3.9/site-packages/mypyc/doc/dev-intro.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../../../../_sources/env/lib/python3.9/site-packages/mypyc/doc/dev-intro.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-differences-from-python">
   Key Differences from Python
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supported-python-features">
   Supported Python Features
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#development-environment">
   Development Environment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compiling-and-running-programs">
   Compiling and Running Programs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-level-overview-of-mypyc">
   High-level Overview of Mypyc
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#useful-background-information">
   Useful Background Information
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mypyc-intermediate-representation-ir">
   Mypyc Intermediate Representation (IR)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-overview">
   Testing overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspecting-generated-ir">
   Inspecting Generated IR
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#type-checking-mypyc">
   Type-checking Mypyc
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#value-representation">
   Value Representation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-generated-c">
   Overview of Generated C
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspecting-generated-c">
   Inspecting Generated C
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-important-limitations">
   Other Important Limitations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hints-for-implementing-typical-mypyc-features">
   Hints for Implementing Typical Mypyc Features
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing">
     Testing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tests-that-compile-and-run-code">
     Tests that compile and run code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ir-tests">
     IR tests
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#benchmarking">
     Benchmarking
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-c-helpers">
     Adding C Helpers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-specialized-primitive-operation">
     Adding a Specialized Primitive Operation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-primitive-type">
     Adding a New Primitive Type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supporting-more-python-syntax">
     Supporting More Python Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-hints">
     Other Hints
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#undocumented-workflows">
   Undocumented Workflows
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Introduction for Mypyc Contributors</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-differences-from-python">
   Key Differences from Python
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supported-python-features">
   Supported Python Features
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#development-environment">
   Development Environment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compiling-and-running-programs">
   Compiling and Running Programs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-level-overview-of-mypyc">
   High-level Overview of Mypyc
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#useful-background-information">
   Useful Background Information
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mypyc-intermediate-representation-ir">
   Mypyc Intermediate Representation (IR)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-overview">
   Testing overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspecting-generated-ir">
   Inspecting Generated IR
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#type-checking-mypyc">
   Type-checking Mypyc
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#value-representation">
   Value Representation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-generated-c">
   Overview of Generated C
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspecting-generated-c">
   Inspecting Generated C
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-important-limitations">
   Other Important Limitations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hints-for-implementing-typical-mypyc-features">
   Hints for Implementing Typical Mypyc Features
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing">
     Testing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tests-that-compile-and-run-code">
     Tests that compile and run code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ir-tests">
     IR tests
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#benchmarking">
     Benchmarking
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-c-helpers">
     Adding C Helpers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-specialized-primitive-operation">
     Adding a Specialized Primitive Operation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-primitive-type">
     Adding a New Primitive Type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supporting-more-python-syntax">
     Supporting More Python Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-hints">
     Other Hints
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#undocumented-workflows">
   Undocumented Workflows
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-for-mypyc-contributors">
<h1>Introduction for Mypyc Contributors<a class="headerlink" href="#introduction-for-mypyc-contributors" title="Permalink to this headline">#</a></h1>
<p>This is a short introduction aimed at anybody who is interested in
contributing to mypyc, or anybody who is curious to understand how
mypyc works internally.</p>
<section id="key-differences-from-python">
<h2>Key Differences from Python<a class="headerlink" href="#key-differences-from-python" title="Permalink to this headline">#</a></h2>
<p>Code compiled using mypyc is often much faster than CPython since it
does these things differently:</p>
<ul class="simple">
<li><p>Mypyc generates C that is compiled to native code, instead of
compiling to interpreted byte code, which CPython uses. Interpreted
byte code always has some interpreter overhead, which slows things
down.</p></li>
<li><p>Mypyc doesn’t let you arbitrarily monkey patch classes and functions
in compiled modules.  This allows <em>early binding</em> – mypyc
statically binds calls to compiled functions, instead of going
through a namespace dictionary.  Mypyc can also call methods of
compiled classes using vtables, which are more efficient than
dictionary lookups used by CPython.</p></li>
<li><p>Mypyc compiles classes to C extension classes, which are generally
more efficient than normal Python classes. They use an efficient,
fixed memory representation (essentially a C struct).  This lets us
use direct memory access instead of (typically) two hash table
lookups to access an attribute.</p></li>
<li><p>As a result of early binding, compiled code can use C calls to call
compiled functions. Keyword arguments can be translated to
positional arguments during compilation. Thus most calls to native
functions and methods directly map to simple C calls. CPython calls
are quite expensive, since mapping of keyword arguments, <code class="docutils literal notranslate"><span class="pre">*args</span></code>,
and so on has to mostly happen at runtime.</p></li>
<li><p>Compiled code has runtime type checks to ensure that runtimes types
match the declared static types. Compiled code can thus make
assumptions about the types of expressions, resulting in both faster
and smaller code, since many runtime type checks performed by the
CPython interpreter can be omitted.</p></li>
<li><p>Compiled code can often use unboxed (not heap allocated)
representations for integers, booleans and tuples.</p></li>
</ul>
</section>
<section id="supported-python-features">
<h2>Supported Python Features<a class="headerlink" href="#supported-python-features" title="Permalink to this headline">#</a></h2>
<p>Mypyc supports a large subset of Python. Note that if you try to
compile something that is not supported, you may not always get a very
good error message.</p>
<p>Here are some major things that aren’t yet supported in compiled code:</p>
<ul class="simple">
<li><p>Many dunder methods (only some work, such as <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and <code class="docutils literal notranslate"><span class="pre">__eq__</span></code>)</p></li>
<li><p>Monkey patching compiled functions or classes</p></li>
<li><p>General multiple inheritance (a limited form is supported)</p></li>
<li><p>Named tuple defined using the class-based syntax</p></li>
<li><p>Defining protocols</p></li>
</ul>
<p>We are generally happy to accept contributions that implement new Python
features.</p>
</section>
<section id="development-environment">
<h2>Development Environment<a class="headerlink" href="#development-environment" title="Permalink to this headline">#</a></h2>
<p>First you should set up the mypy development environment as described in
the <a class="reference external" href="https://github.com/python/mypy/blob/master/README.md">mypy docs</a>.
macOS, Linux and Windows are supported.</p>
</section>
<section id="compiling-and-running-programs">
<h2>Compiling and Running Programs<a class="headerlink" href="#compiling-and-running-programs" title="Permalink to this headline">#</a></h2>
<p>When working on a mypyc feature or a fix, you’ll often need to run
compiled code. For example, you may want to do interactive testing or
to run benchmarks. This is also handy if you want to inspect the
generated C code (see Inspecting Generated C).</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">mypyc</span></code> to compile a module to a C extension using your
development version of mypyc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mypyc program.py
</pre></div>
</div>
<p>This will generate a C extension for <code class="docutils literal notranslate"><span class="pre">program</span></code> in the current working
directory.  For example, on a Linux system the generated file may be
called <code class="docutils literal notranslate"><span class="pre">program.cpython-37m-x86_64-linux-gnu.so</span></code>.</p>
<p>Since C extensions can’t be run as programs, use <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">-c</span></code> to run
the compiled module as a program:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 -c &quot;import program&quot;
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">__name__</span></code> in <code class="docutils literal notranslate"><span class="pre">program.py</span></code> will now be <code class="docutils literal notranslate"><span class="pre">program</span></code>, not
<code class="docutils literal notranslate"><span class="pre">__main__</span></code>!</p>
<p>You can manually delete the C extension to get back to an interpreted
version (this example works on Linux):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rm program.*.so
</pre></div>
</div>
<p>Another option is to invoke mypyc through tests (see Testing below).</p>
</section>
<section id="high-level-overview-of-mypyc">
<h2>High-level Overview of Mypyc<a class="headerlink" href="#high-level-overview-of-mypyc" title="Permalink to this headline">#</a></h2>
<p>Mypyc compiles a Python module (or a set of modules) to C, and
compiles the generated C to a Python C extension module (or
modules). You can compile only a subset of your program to C –
compiled and interpreted code can freely and transparently
interact. You can also freely use any Python libraries (including C
extensions) in compiled code.</p>
<p>Mypyc will only make compiled code faster. To see a significant
speedup, you must make sure that most of the time is spent in compiled
code – and not in libraries, for example.</p>
<p>Mypyc has these passes:</p>
<ul class="simple">
<li><p>Type check the code using mypy and infer types for variables and
expressions.  This produces a mypy AST (defined in <code class="docutils literal notranslate"><span class="pre">mypy.nodes</span></code>) and
a type map that describes the inferred types (<code class="docutils literal notranslate"><span class="pre">mypy.types.Type</span></code>) of
all expressions (as PEP 484 types).</p></li>
<li><p>Translate the mypy AST into a mypyc-specific intermediate representation (IR).</p>
<ul>
<li><p>The IR is defined in <code class="docutils literal notranslate"><span class="pre">mypyc.ir</span></code> (see below for an explanation of the IR).</p></li>
<li><p>Various primitive operations used in the IR are defined in <code class="docutils literal notranslate"><span class="pre">mypyc.primitives</span></code>.</p></li>
<li><p>The translation to IR happens in <code class="docutils literal notranslate"><span class="pre">mypyc.irbuild</span></code>. The top-level logic is in
<code class="docutils literal notranslate"><span class="pre">mypyc.irbuild.main</span></code>.</p></li>
</ul>
</li>
<li><p>Insert checks for uses of potentially uninitialized variables
(<code class="docutils literal notranslate"><span class="pre">mypyc.transform.uninit</span></code>).</p></li>
<li><p>Insert exception handling (<code class="docutils literal notranslate"><span class="pre">mypyc.transform.exceptions</span></code>).</p></li>
<li><p>Insert explicit reference count inc/dec opcodes (<code class="docutils literal notranslate"><span class="pre">mypyc.transform.refcount</span></code>).</p></li>
<li><p>Translate the IR into C (<code class="docutils literal notranslate"><span class="pre">mypyc.codegen</span></code>).</p></li>
<li><p>Compile the generated C code using a C compiler (<code class="docutils literal notranslate"><span class="pre">mypyc.build</span></code>).</p></li>
</ul>
</section>
<section id="useful-background-information">
<h2>Useful Background Information<a class="headerlink" href="#useful-background-information" title="Permalink to this headline">#</a></h2>
<p>Beyond the mypy documentation, here are some things that are helpful to
know for mypyc contributors:</p>
<ul class="simple">
<li><p>Experience with C
(<a class="reference external" href="https://en.wikipedia.org/wiki/The_C_Programming_Language">The C Programming Language</a>
is a classic book about C)</p></li>
<li><p>Basic familiarity with the Python C API (see
<a class="reference external" href="https://docs.python.org/3/c-api/intro.html">Python C API documentation</a>). <a class="reference external" href="https://docs.python.org/3/extending/index.html">Extending and Embedding the Python Interpreter</a> is a good tutorial for beginners.</p></li>
<li><p>Basics of compilers (see the
<a class="reference external" href="https://github.com/python/mypy/wiki/Learning-Resources">mypy wiki</a>
for some ideas)</p></li>
</ul>
</section>
<section id="mypyc-intermediate-representation-ir">
<h2>Mypyc Intermediate Representation (IR)<a class="headerlink" href="#mypyc-intermediate-representation-ir" title="Permalink to this headline">#</a></h2>
<p>The mypyc IR is defined in <code class="docutils literal notranslate"><span class="pre">mypyc.ir</span></code>. It covers several key concepts
that are essential to understand by all mypyc contributors:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mypyc.ir.ops.Op</span></code> is an Abstract Base Class for all IR
operations. These are low-level and generally map to simple
fragments of C each. Mypy expressions are translated to
linear sequences of these ops.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mypyc.ir.ops.BasicBlock</span></code> is a container of a sequence of ops with a
branch/goto/return at the end, and no branch/goto/return ops in the
middle. Each function is compiled to a bunch of basic blocks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mypyc.ir.rtypes.RType</span></code> and its subclasses are the types used for
everything in the IR. These are lower-level and simpler than mypy or
PEP 484 types. For example, there are no general-purpose generic
types types here. Each <code class="docutils literal notranslate"><span class="pre">List[X]</span></code> type (for any <code class="docutils literal notranslate"><span class="pre">X</span></code>) is represented
by a single <code class="docutils literal notranslate"><span class="pre">list</span></code> type, for example.</p></li>
<li><p>Primitive types are special RTypes of which mypyc has some special
understanding, and there are typically some specialized
ops. Examples include <code class="docutils literal notranslate"><span class="pre">int</span></code> (referred to as <code class="docutils literal notranslate"><span class="pre">int_rprimitive</span></code> in the
code) and <code class="docutils literal notranslate"><span class="pre">list</span></code> (<code class="docutils literal notranslate"><span class="pre">list_rprimitive</span></code>). Python types for which there
is no specific RType type will be represented by the catch-all
<code class="docutils literal notranslate"><span class="pre">object_rprimitive</span></code> type.</p></li>
<li><p>Instances of compiled classes are generally represented using the
<code class="docutils literal notranslate"><span class="pre">RInstance</span></code> type.  Classes are compiled to C extension classes and
contain vtables for fast method calls and fast attribute access.</p></li>
<li><p>IR representations of functions and classes live in
<code class="docutils literal notranslate"><span class="pre">mypyc.ir.func_ir</span></code> and <code class="docutils literal notranslate"><span class="pre">mypyc.ir.class_ir</span></code>, respectively.</p></li>
</ul>
<p>Look at the docstrings and comments in <code class="docutils literal notranslate"><span class="pre">mypyc.ir</span></code> for additional
information. See the test cases in
<code class="docutils literal notranslate"><span class="pre">mypyc/test-data/irbuild-basic.test</span></code> for examples of what the IR looks
like in a pretty-printed form.</p>
</section>
<section id="testing-overview">
<h2>Testing overview<a class="headerlink" href="#testing-overview" title="Permalink to this headline">#</a></h2>
<p>Most mypyc test cases are defined in the same format (<code class="docutils literal notranslate"><span class="pre">.test</span></code>) as used
for test cases for mypy. Look at mypy developer documentation for a
general overview of how things work. Test cases live under
<code class="docutils literal notranslate"><span class="pre">mypyc/test-data/</span></code>, and you can run all mypyc tests via <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-q</span> <span class="pre">mypyc</span></code>. If you don’t make changes to code under <code class="docutils literal notranslate"><span class="pre">mypy/</span></code>, it’s not
important to regularly run mypy tests during development.</p>
<p>When you create a PR, we have Continuous Integration jobs set up that
compile mypy using mypyc and run the mypy test suite using the
compiled mypy. This will sometimes catch additional issues not caught
by the mypyc test suite. It’s okay to not do this in your local
development environment.</p>
<p>We discuss writing tests in more detail later in this document.</p>
</section>
<section id="inspecting-generated-ir">
<h2>Inspecting Generated IR<a class="headerlink" href="#inspecting-generated-ir" title="Permalink to this headline">#</a></h2>
<p>It’s often useful to look at the generated IR when debugging issues or
when trying to understand how mypyc compiles some code.  When you
compile some module by running <code class="docutils literal notranslate"><span class="pre">mypyc</span></code>, mypyc will write the
pretty-printed IR into <code class="docutils literal notranslate"><span class="pre">build/ops.txt</span></code>. This is the final IR that
includes the output from exception and reference count handling
insertion passes.</p>
<p>We also have tests that verify the generate IR
(<code class="docutils literal notranslate"><span class="pre">mypyc/test-data/irbuild-*.text</span></code>).</p>
</section>
<section id="type-checking-mypyc">
<h2>Type-checking Mypyc<a class="headerlink" href="#type-checking-mypyc" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">./runtests.py</span> <span class="pre">self</span></code> type checks mypy and mypyc. This is pretty slow,
however, since it’s using an uncompiled mypy.</p>
<p>Installing a released version of mypy using <code class="docutils literal notranslate"><span class="pre">pip</span></code> (which is compiled)
and using <code class="docutils literal notranslate"><span class="pre">dmypy</span></code> (mypy daemon) is a much, much faster way to type
check mypyc during development.</p>
</section>
<section id="value-representation">
<h2>Value Representation<a class="headerlink" href="#value-representation" title="Permalink to this headline">#</a></h2>
<p>Mypyc uses a tagged pointer representation for values of type <code class="docutils literal notranslate"><span class="pre">int</span></code>
(<code class="docutils literal notranslate"><span class="pre">CPyTagged</span></code>), <code class="docutils literal notranslate"><span class="pre">char</span></code> for booleans, and C structs for tuples. For most
other objects mypyc uses the CPython <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>.</p>
<p>Python integers that fit in 31/63 bits (depending on whether we are on
a 32-bit or 64-bit platform) are represented as C integers
(<code class="docutils literal notranslate"><span class="pre">CPyTagged</span></code>) shifted left by 1. Integers that don’t fit in this
representation are represented as pointers to a <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code> (this is
always a Python <code class="docutils literal notranslate"><span class="pre">int</span></code> object) with the least significant bit
set. Tagged integer operations are defined in <code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt/int_ops.c</span></code>
and <code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt/CPy.h</span></code>.</p>
<p>There are also low-level integer types, such as <code class="docutils literal notranslate"><span class="pre">int32</span></code> (see
<code class="docutils literal notranslate"><span class="pre">mypyc.ir.rtypes</span></code>), that don’t use the tagged representation. These
types are not exposed to users, but they are used in generated code.</p>
</section>
<section id="overview-of-generated-c">
<h2>Overview of Generated C<a class="headerlink" href="#overview-of-generated-c" title="Permalink to this headline">#</a></h2>
<p>Mypyc compiles a function into two functions, a native function and
a wrapper function:</p>
<ul class="simple">
<li><p>The native function takes a fixed number of C arguments with the
correct C types. It assumes that all argument have correct types.</p></li>
<li><p>The wrapper function conforms to the Python C API calling convention
and takes an arbitrary set of arguments. It processes the arguments,
checks their types, unboxes values with special representations and
calls the native function. The return value from the native function
is translated back to a Python object (“boxing”).</p></li>
</ul>
<p>Calls to other compiled functions don’t go through the Python module
namespace but directly call the target native C function. This makes
calls very fast compared to CPython.</p>
<p>The generated code does runtime checking so that it can assume that
values always have the declared types. Whenever accessing CPython
values which might have unexpected types we need to insert a runtime
type check operation. For example, when getting a list item we need to
insert a runtime type check (an unbox or a cast operation), since
Python lists can contain arbitrary objects.</p>
<p>The generated code uses various helpers defined in
<code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt/CPy.h</span></code>. The implementations are in various <code class="docutils literal notranslate"><span class="pre">.c</span></code> files
under <code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt</span></code>.</p>
</section>
<section id="inspecting-generated-c">
<h2>Inspecting Generated C<a class="headerlink" href="#inspecting-generated-c" title="Permalink to this headline">#</a></h2>
<p>It’s often useful to inspect the C code genenerate by mypyc to debug
issues.  Mypyc stores the generated C code as <code class="docutils literal notranslate"><span class="pre">build/__native.c</span></code>.
Compiled native functions have the prefix <code class="docutils literal notranslate"><span class="pre">CPyDef_</span></code>, while wrapper
functions used for calling functions from interpreted Python code have
the <code class="docutils literal notranslate"><span class="pre">CPyPy_</span></code> prefix.</p>
</section>
<section id="other-important-limitations">
<h2>Other Important Limitations<a class="headerlink" href="#other-important-limitations" title="Permalink to this headline">#</a></h2>
<p>All of these limitations will likely be fixed in the future:</p>
<ul class="simple">
<li><p>We don’t detect stack overflows.</p></li>
<li><p>We don’t handle Ctrl-C in compiled code.</p></li>
</ul>
</section>
<section id="hints-for-implementing-typical-mypyc-features">
<h2>Hints for Implementing Typical Mypyc Features<a class="headerlink" href="#hints-for-implementing-typical-mypyc-features" title="Permalink to this headline">#</a></h2>
<p>This section gives an overview of where to look for and
what to do to implement specific kinds of mypyc features.</p>
<section id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">#</a></h3>
<p>Our bread-and-butter testing strategy is compiling code with mypyc and
running it. There are downsides to this (kind of slow, tests a huge
number of components at once, insensitive to the particular details of
the IR), but there really is no substitute for running code. You can
also write tests that test the generated IR, however.</p>
</section>
<section id="tests-that-compile-and-run-code">
<h3>Tests that compile and run code<a class="headerlink" href="#tests-that-compile-and-run-code" title="Permalink to this headline">#</a></h3>
<p>Test cases that compile and run code are located in
<code class="docutils literal notranslate"><span class="pre">mypyc/test-data/run*.test</span></code> and the test runner is in
<code class="docutils literal notranslate"><span class="pre">mypyc.test.test_run</span></code>.  The code to compile comes after <code class="docutils literal notranslate"><span class="pre">[case</span> <span class="pre">test&lt;name&gt;]</span></code>. The code gets saved into the file <code class="docutils literal notranslate"><span class="pre">native.py</span></code>, and it
gets compiled into the module <code class="docutils literal notranslate"><span class="pre">native</span></code>.</p>
<p>Each test case uses a non-compiled Python driver that imports the
<code class="docutils literal notranslate"><span class="pre">native</span></code> module and typically calls some compiled functions. Some
tests also perform assertions and print messages in the driver.</p>
<p>If you don’t provide a driver, a default driver is used. The default
driver just calls each module-level function that is prefixed with
<code class="docutils literal notranslate"><span class="pre">test_</span></code> and reports any uncaught exceptions as failures. (Failure to
build or a segfault also count as failures.) <code class="docutils literal notranslate"><span class="pre">testStringOps</span></code> in
<code class="docutils literal notranslate"><span class="pre">mypyc/test-data/run-strings.test</span></code> is an example of a test that uses
the default driver.</p>
<p>You should usually use the default driver (don’t include
<code class="docutils literal notranslate"><span class="pre">driver.py</span></code>). It’s the simplest way to write most tests.</p>
<p>Here’s an example test case that uses the default driver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">case</span> <span class="n">testConcatenateLists</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">test_concat_lists</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test_concat_empty_lists</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="p">[]</span> <span class="o">+</span> <span class="p">[]</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
<p>There is one test case, <code class="docutils literal notranslate"><span class="pre">testConcatenateLists</span></code>. It has two sub-cases,
<code class="docutils literal notranslate"><span class="pre">test_concat_lists</span></code> and <code class="docutils literal notranslate"><span class="pre">test_concat_empty_lists</span></code>. Note that you can
use the pytest -k argument to only run <code class="docutils literal notranslate"><span class="pre">testConcetanateLists</span></code>, but you
can’t filter tests at the sub-case level.</p>
<p>It’s recommended to have multiple sub-cases per test case, since each
test case has significant fixed overhead. Each test case is run in a
fresh Python subprocess.</p>
<p>Many of the existing test cases provide a custom driver by having
<code class="docutils literal notranslate"><span class="pre">[file</span> <span class="pre">driver.py]</span></code>, followed by the driver implementation. Here the
driver is not compiled, which is useful if you want to test
interactions between compiled and non-compiled code. However, many of
the tests don’t have a good reason to use a custom driver – when they
were written, the default driver wasn’t available.</p>
<p>Test cases can also have a <code class="docutils literal notranslate"><span class="pre">[out]</span></code> section, which specifies the
expected contents of stdout the test case should produce. New test
cases should prefer assert statements to <code class="docutils literal notranslate"><span class="pre">[out]</span></code> sections.</p>
</section>
<section id="ir-tests">
<h3>IR tests<a class="headerlink" href="#ir-tests" title="Permalink to this headline">#</a></h3>
<p>If the specifics of the generated IR of a change is important
(because, for example, you want to make sure a particular optimization
is triggering), you should add a <code class="docutils literal notranslate"><span class="pre">mypyc.irbuild</span></code> test as well.  Test
cases are located in <code class="docutils literal notranslate"><span class="pre">mypyc/test-data/irbuild-*.test</span></code> and the test
driver is in <code class="docutils literal notranslate"><span class="pre">mypyc.test.test_irbuild</span></code>. IR build tests do a direct
comparison of the IR output, so try to make the test as targeted as
possible so as to capture only the important details.  (Many of our
existing IR build tests do not follow this advice, unfortunately!)</p>
<p>If you pass the <code class="docutils literal notranslate"><span class="pre">--update-data</span></code> flag to pytest, it will automatically
update the expected output of any tests to match the actual
output. This is very useful for changing or creating IR build tests,
but make sure to carefully inspect the diff!</p>
<p>You may also need to add some definitions to the stubs used for
builtins during tests (<code class="docutils literal notranslate"><span class="pre">mypyc/test-data/fixtures/ir.py</span></code>). We don’t use
full typeshed stubs to run tests since they would seriously slow down
tests.</p>
</section>
<section id="benchmarking">
<h3>Benchmarking<a class="headerlink" href="#benchmarking" title="Permalink to this headline">#</a></h3>
<p>Many mypyc improvements attempt to make some operations faster. For
any such change, you should run some measurements to verify that
there actually is a measurable performance impact.</p>
<p>A typical benchmark would initialize some data to be operated on, and
then measure time spent in some function. In particular, you should
not measure time needed to run the entire benchmark program, as this
would include Python startup overhead and other things that aren’t
relevant. In general, for microbenchmarks, you want to do as little as
possible in the timed portion. So ideally you’ll just have some loops
and the code under test. Be ready to provide your benchmark in code
review so that mypyc developers can check that the benchmark is fine
(writing a good benchmark is non-trivial).</p>
<p>You should run a benchmark at least five times, in both original and
changed versions, ignore outliers, and report the average
runtime. Actual performance of a typical desktop or laptop computer is
quite variable, due to dynamic CPU clock frequency changes, background
processes, etc. If you observe a high variance in timings, you’ll need
to run the benchmark more times. Also try closing most applications,
including web browsers.</p>
<p>Interleave original and changed runs. Don’t run 10 runs with variant A
followed by 10 runs with variant B, but run an A run, a B run, an A
run, etc. Otherwise you risk that the CPU frequency will be different
between variants. You can also try adding a delay of 5 to 20s between
runs to avoid CPU frequency changes.</p>
<p>Instead of averaging over many measurements, you can try to adjust
your environment to provide more stable measurements. However, this
can be hard to do with some hardware, including many laptops.  Victor
Stinner has written a series of blog posts about making measurements
stable:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-system.html">https://vstinner.github.io/journey-to-stable-benchmark-system.html</a></p></li>
<li><p><a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-average.html">https://vstinner.github.io/journey-to-stable-benchmark-average.html</a></p></li>
</ul>
</section>
<section id="adding-c-helpers">
<h3>Adding C Helpers<a class="headerlink" href="#adding-c-helpers" title="Permalink to this headline">#</a></h3>
<p>If you add an operation that compiles into a lot of C code, you may
also want to add a C helper function for the operation to make the
generated code smaller. Here is how to do this:</p>
<ul class="simple">
<li><p>Declare the operation in <code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt/CPy.h</span></code>. We avoid macros, and
we generally avoid inline functions to make it easier to target
additional backends in the future.</p></li>
<li><p>Consider adding a unit test for your C helper in <code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt/test_capi.cc</span></code>.
We use
<a class="reference external" href="https://github.com/google/googletest">Google Test</a> for writing
tests in C++. The framework is included in the repository under the
directory <code class="docutils literal notranslate"><span class="pre">googletest/</span></code>. The C unit tests are run as part of the
pytest test suite (<code class="docutils literal notranslate"><span class="pre">test_c_unit_test</span></code>).</p></li>
</ul>
</section>
<section id="adding-a-specialized-primitive-operation">
<h3>Adding a Specialized Primitive Operation<a class="headerlink" href="#adding-a-specialized-primitive-operation" title="Permalink to this headline">#</a></h3>
<p>Mypyc speeds up operations on primitive types such as <code class="docutils literal notranslate"><span class="pre">list</span></code> and <code class="docutils literal notranslate"><span class="pre">int</span></code>
by having primitive operations specialized for specific types. These
operations are declared in <code class="docutils literal notranslate"><span class="pre">mypyc.primitives</span></code> (and
<code class="docutils literal notranslate"><span class="pre">mypyc/lib-rt/CPy.h</span></code>).  For example, <code class="docutils literal notranslate"><span class="pre">mypyc.primitives.list_ops</span></code>
contains primitives that target list objects.</p>
<p>The operation definitions are data driven: you specify the kind of
operation (such as a call to <code class="docutils literal notranslate"><span class="pre">builtins.len</span></code> or a binary addition) and
the operand types (such as <code class="docutils literal notranslate"><span class="pre">list_primitive</span></code>), and what code should be
generated for the operation. Mypyc does AST matching to find the most
suitable primitive operation automatically.</p>
<p>Look at the existing primitive definitions and the docstrings in
<code class="docutils literal notranslate"><span class="pre">mypyc.primitives.registry</span></code> for examples and more information.</p>
</section>
<section id="adding-a-new-primitive-type">
<h3>Adding a New Primitive Type<a class="headerlink" href="#adding-a-new-primitive-type" title="Permalink to this headline">#</a></h3>
<p>Some types (typically Python Python built-in types), such as <code class="docutils literal notranslate"><span class="pre">int</span></code> and
<code class="docutils literal notranslate"><span class="pre">list</span></code>, are special cased in mypyc to generate optimized operations
specific to these types. We’ll occasionally want to add additional
primitive types.</p>
<p>Here are some hints about how to add support for a new primitive type
(this may be incomplete):</p>
<ul class="simple">
<li><p>Decide whether the primitive type has an “unboxed” representation (a
representation that is not just <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>). For most types we’ll
use a boxed representation, as it’s easier to implement and more
closely matches Python semantics.</p></li>
<li><p>Create a new instance of <code class="docutils literal notranslate"><span class="pre">RPrimitive</span></code> to support the primitive type
and add it to <code class="docutils literal notranslate"><span class="pre">mypyc.ir.rtypes</span></code>. Make sure all the attributes are
set correctly and also define <code class="docutils literal notranslate"><span class="pre">&lt;foo&gt;_rprimitive</span></code> and
<code class="docutils literal notranslate"><span class="pre">is_&lt;foo&gt;_rprimitive</span></code>.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">mypyc.irbuild.mapper.Mapper.type_to_rtype()</span></code>.</p></li>
<li><p>If the type is not unboxed, update <code class="docutils literal notranslate"><span class="pre">emit_cast</span></code> in <code class="docutils literal notranslate"><span class="pre">mypyc.codegen.emit</span></code>.</p></li>
</ul>
<p>If the type is unboxed, there are some additional steps:</p>
<ul class="simple">
<li><p>Update <code class="docutils literal notranslate"><span class="pre">emit_box</span></code> in <code class="docutils literal notranslate"><span class="pre">mypyc.codegen.emit</span></code>.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">emit_unbox</span></code> in <code class="docutils literal notranslate"><span class="pre">mypyc.codegen.emit</span></code>.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">emit_inc_ref</span></code> and <code class="docutils literal notranslate"><span class="pre">emit_dec_ref</span></code> in <code class="docutils literal notranslate"><span class="pre">mypypc.codegen.emit</span></code>.
If the unboxed representation does not need reference counting,
these can be no-ops.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">emit_error_check</span></code> in <code class="docutils literal notranslate"><span class="pre">mypyc.codegen.emit</span></code>.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">emit_gc_visit</span></code> and <code class="docutils literal notranslate"><span class="pre">emit_gc_clear</span></code> in <code class="docutils literal notranslate"><span class="pre">mypyc.codegen.emit</span></code>
if the type has an unboxed representation with pointers.</p></li>
</ul>
<p>The above may be enough to allow you to declare variables with the
type, pass values around, perform runtime type checks, and use generic
fallback primitive operations to perform method calls, binary
operations, and so on. You likely also want to add some faster,
specialized primitive operations for the type (see Adding a
Specialized Primitive Operation above for how to do this).</p>
<p>Add a test case to <code class="docutils literal notranslate"><span class="pre">mypyc/test-data/run*.test</span></code> to test compilation and
running compiled code. Ideas for things to test:</p>
<ul class="simple">
<li><p>Test using the type as an argument.</p></li>
<li><p>Test using the type as a return value.</p></li>
<li><p>Test passing a value of the type to a function both within
compiled code and from regular Python code. Also test this
for return values.</p></li>
<li><p>Test using the type as list item type. Test both getting a list item
and setting a list item.</p></li>
</ul>
</section>
<section id="supporting-more-python-syntax">
<h3>Supporting More Python Syntax<a class="headerlink" href="#supporting-more-python-syntax" title="Permalink to this headline">#</a></h3>
<p>Mypyc supports most Python syntax, but there are still some gaps.</p>
<p>Support for syntactic sugar that doesn’t need additional IR operations
typically only requires changes to <code class="docutils literal notranslate"><span class="pre">mypyc.irbuild</span></code>.</p>
<p>Some new syntax also needs new IR primitives to be added to
<code class="docutils literal notranslate"><span class="pre">mypyc.primitives</span></code>. See <code class="docutils literal notranslate"><span class="pre">mypyc.primitives.registry</span></code> for documentation
about how to do this.</p>
</section>
<section id="other-hints">
<h3>Other Hints<a class="headerlink" href="#other-hints" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>This developer documentation is not aimed to be very complete. Much
of our documentation is in comments and docstring in the code. If
something is unclear, study the code.</p></li>
<li><p>It can be useful to look through some recent PRs to get an idea of
what typical code changes, test cases, etc. look like.</p></li>
<li><p>Feel free to open GitHub issues with questions if you need help when
contributing, or ask questions in existing issues. Note that we only
support contributors. Mypyc is not (yet) an end-user product. You
can also ask questions in our Gitter chat
(<a class="reference external" href="https://gitter.im/mypyc-dev/community">https://gitter.im/mypyc-dev/community</a>).</p></li>
</ul>
</section>
</section>
<section id="undocumented-workflows">
<h2>Undocumented Workflows<a class="headerlink" href="#undocumented-workflows" title="Permalink to this headline">#</a></h2>
<p>These workflows would be useful for mypyc contributors. We should add
them to mypyc developer documentation:</p>
<ul class="simple">
<li><p>How to inspect the generated IR before some transform passes.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./env/lib/python3.9/site-packages/mypyc/doc"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Jupyter Book Community<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>